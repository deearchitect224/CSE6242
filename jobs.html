<!doctype html>
<html lang="en">
<head>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

<style>

.states :hover {
  fill: red;
}

.state-borders {
  fill: none;
  stroke: #fff;
  stroke-width: 0.5px;
  stroke-linejoin: round;
  stroke-linecap: round;
  pointer-events: none;
}

</style>
</head>
    <body>
        
    <div class="container">
        <!-- Add heading for the visualization -->
        <h2>Visualization of Jobs landscape in the US over the years 2001 - 2019</h2>
            
        <!-- Dropdown -->
        <div  class="p-3 mb-2 bg-light text-dark" >
            <text>Select Job Category and year: </text><select id="categorySelection"></select>
        </div>
        <div class="p-3 mb-2 bg-light text-success" id="slider"><p class="text-center"></p></div>
        <!-- append visualization svg to this div-->
        <div id="choropleth"></div>
    </div>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <!-- <script src="https://unpkg.com/d3-simple-slider"></script> -->
    <script>

        // enter code to define margin and dimensions for svg
		var margin = {top: 10, right: 60, bottom: 30, left: 60},
        width = 960 - margin.left - margin.right,
        height = 600 - margin.top - margin.bottom;

		// enter code to create svg
		var svg = d3.select("#choropleth")
          .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform",
                  "translate(" + margin.left + "," + margin.top + ")");
        var color = d3.scaleQuantile().range(["#fff5eb",
        "#fee6ce",
"#fdd0a2",
"#fdae6b",
"#fd8d3c",
"#f16913",
"#d94801",
"#a63603",
"#7f2704",]);

        var globalJobsData = [];
		var currentSelection = "";
        var defaultSelection = "Computer and Mathematical Occupations";
        var currentYear = 2000;
        var us_states= [];
        var animated;
    
    var path = d3.geoPath();
    

    var promises = [];
    promises.push(d3.json('divya2001-2005.json'));
    promises.push(d3.json('divya2006-2009.json'));
    promises.push(d3.json('divya2010-2015.json'));
    promises.push(d3.json('divya2016-2019.json'));
    promises.push(d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-albers-10m.json'));

    Promise.all(promises).then(
        // enter code to call ready() with required arguments
        results => {
            consolidatedResults = [...results[0], ...results[1], ...results[2], ...results[3]];
            globalJobsData = consolidatedResults;
            us_states = results[4];
            ready(null, results[4], consolidatedResults);
    });

    var myanimation = function() {
        console.log("tick" + currentYear);
        currentYear = currentYear + 1;
        d3.select("#slider").select("p")
            .text("Year: " + currentYear)
            .attr("text-anchor","middle")
            .attr('font-size','8pt');
        createMapAndLegend(us_states, globalJobsData, currentSelection, currentYear);
    };

    function ready(error, us, jobs) {
        // enter code to extract all unique games from gameData
        const uniqueJobCategories = [...new Set(jobs.filter(x => x["occ_code 2"] === 0).map(x => x["occ_title"].toLowerCase()))];
                
        // enter code to append the game options to the dropdown
        d3.select("#categorySelection")
            .selectAll('myOptions')
            .data(uniqueJobCategories)
            .enter()
                .append('option')
                .text(function (d) { return d; }) // text showed in the menu
                .attr("value", function (d) { return d; }); // corresponding value returned by the button
        
    //             var slider = d3
    // .sliderHorizontal()
    // .min(2000)
    // .max(2019)
    // .step(1)
    // .width(400)
    // .displayValue(true)
    // .on('onchange', (val) => {
    //     var currentValue = val;
    //         console.log(currentValue);
    //         currentSelection = d3.select("#categorySelection").property("value");
    //         createMapAndLegend(us, jobs, currentSelection, currentValue);
    // })
  //  ;
        // event listener for the dropdown. Update choropleth and legend when selection changes. Call createMapAndLegend() with required arguments.
        d3.select("#categorySelection").on("change", function(d) {
            currentSelection = d3.select(this).property("value");
            //currentYear = d3.select("#slider").property("value");
            currentYear = 2000;
            animated = setInterval(myanimation, 100); 
        });

    

//   d3.select('#slider')
//     .append('svg')
//     .attr('width', 500)
//     .attr('height', 100)
//     .append('g')
//     .attr('transform', 'translate(30,30)')
//     .call(slider);

    createMapAndLegend(us, jobs, defaultSelection, currentYear);
}

    function createMapAndLegend(us, jobs, selectedCategory, year){ 
            //console.log(year);
            //Fix this for stretching the domain only for selected category
            if(currentYear >= 2019) {
                window.clearInterval(animated);
            }

            var jobsColor = jobs.filter((job) => (job["occ_title"].toLowerCase() === selectedCategory.toLowerCase() && job["year"] === year));

            color.domain([
                d3.min(jobsColor, function(d){ return parseFloat(d["tot_emp"])}),
                d3.max(jobsColor, function(d){ return parseFloat(d["tot_emp"])})
            ]);
            console.log(year);
            console.log(selectedCategory);
            
            
            currentSelection = selectedCategory;
            currentYear = parseInt(year);
            var g = svg.append("g").attr("class", "states");
            
                g.selectAll("path")
                .data(topojson.feature(us, us.objects.states).features) // Bind TopoJSON data elements
                .enter()
                    .append("path")
                    .attr("d", path)
                    .style("fill", function(d) {
                        var jobUS = jobs.filter((job) => (job["state"].toLowerCase() === d.properties.name.toLowerCase() && job["occ_title"].toLowerCase() === currentSelection.toLowerCase() && job["year"] === currentYear));
                        var value = jobUS[0];
                        //console.log(value);
                        if(value && value["tot_emp"]) {
                            return color(parseFloat(value["tot_emp"]));
                        } else {
                            return "#ccc"
                        }
                    }).style("stroke", "#FFFFFF");
                
                    g.selectAll("text")
                        .data(topojson.feature(us, us.objects.states).features)
                        .enter()
                        .append("svg:text")
                        .text(function(d){
                            return d.properties.name;
                        })
                        .attr("x", function(d){
                            return path.centroid(d)[0];
                        })
                        .attr("y", function(d){
                            return  path.centroid(d)[1];
                        })
                        .attr("text-anchor","middle")
                        .attr('font-size','8pt');
                
        }

    </script>
</body>
</html>